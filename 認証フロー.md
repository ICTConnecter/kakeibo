# 認証・登録フロー

## 📊 システム全体のフロー

```
1. ユーザーがLIFFアプリを開く
   ↓
2. LIFF SDK初期化 & LINE認証
   ↓
3. IDトークン取得
   ↓
4. /api/auth にアクセス（認証確認）
   ↓
   ├─ 登録済み → /home へリダイレクト
   └─ 未登録 → /register へリダイレクト
       ↓
5. /register で登録処理
   ├─ Household作成
   ├─ User作成
   ├─ デフォルトマスタデータ作成
   │   ├─ カテゴリ（支出・収入）
   │   ├─ ウォレット
   │   └─ 経費タイプ
   ↓
6. /home へリダイレクト（家計簿開始）
```

---

## 🔐 認証API (`/api/auth`)

### エンドポイント
```
GET /api/auth
```

### リクエストヘッダー
```
Authorization: Bearer:{IDトークン}
```

### レスポンス

#### ✅ 成功時（登録済み）
```json
{
  "userId": "U1234567890abcdef",
  "displayName": "山田太郎",
  "pictureUrl": "https://profile.line-scdn.net/...",
  "email": "yamada@example.com",
  "householdId": "household123",
  "isRegistered": true
}
```

#### ❌ 未登録時
```json
{
  "error": "登録情報が見当たりませんでした。",
  "isRegistered": false
}
```
→ フロントエンドで `/register` にリダイレクト

---

## 📝 登録API (`/api/register`)

### エンドポイント
```
POST /api/register
```

### リクエストヘッダー
```
Authorization: Bearer:{IDトークン}
Content-Type: application/json
```

### リクエストボディ
なし（IDトークンから情報を取得）

### 処理内容

#### 1. ユーザー情報の抽出
IDトークンをデコードして以下を取得：
- `sub`: ユーザーID（LINE User ID）
- `name`: 表示名
- `picture`: プロフィール画像URL
- `email`: メールアドレス

#### 2. Householdの作成
```typescript
{
  name: "{ユーザー名}の家計簿",
  ownerId: "{userId}",
  members: [
    {
      userId: "{userId}",
      role: "owner",
      joinedAt: {timestamp}
    }
  ],
  createdAt: {timestamp},
  updatedAt: {timestamp}
}
```

#### 3. Userの作成
```typescript
{
  userId: "{LINE User ID}",
  displayName: "{表示名}",
  pictureUrl: "{プロフィール画像URL}",
  email: "{メールアドレス}",
  createdAt: {timestamp},
  updatedAt: {timestamp}
}
```

#### 4. デフォルトマスタデータの作成

##### カテゴリ（支出）
- 食費、家賃、光熱費、交通費、医療費、娯楽費、衣服費、通信費、その他

##### カテゴリ（収入）
- 給与、ボーナス、副業、投資・配当、お小遣い、その他収入

##### ウォレット
- 現金、クレジットカード、デビットカード、電子マネー、銀行口座

##### 経費タイプ
- 事業用、接待交際費、交通費（業務用）、消耗品費、通信費（業務用）、広告宣伝費、その他経費

### レスポンス

#### ✅ 成功時
```json
{
  "success": true,
  "message": "User registered successfully",
  "data": {
    "userId": "U1234567890abcdef",
    "householdId": "household123"
  }
}
```

#### ❌ エラー時
```json
{
  "error": "User already exists"
}
```

---

## 🖼️ 登録画面 (`/register`)

### 表示内容

1. **アプリロゴ・タイトル**
   - 💰 AI家計簿

2. **プロフィール情報**
   - LINEから取得した情報を表示
   - プロフィール画像
   - 表示名
   - メールアドレス

3. **自動作成される内容の説明**
   - あなた専用の家計簿
   - デフォルトカテゴリ
   - デフォルトウォレット
   - デフォルト経費タイプ

4. **登録ボタン**
   - クリックで `/api/register` に POST

### フロー
```
1. ページ表示
   ↓
2. LIFFContextから情報取得
   ↓
3. ユーザーが「アカウント登録」ボタンをクリック
   ↓
4. /api/register にPOST
   ↓
5. 登録成功
   ↓
6. アラート表示「アカウント登録が完了しました！」
   ↓
7. /home にリダイレクト
```

---

## 🔄 認証状態の管理

### UserAuthComponentでの処理

1. **LIFFコンテキストから情報取得**
   - IDトークン
   - デコード結果

2. **認証API呼び出し**
   ```typescript
   fetch('/api/auth', {
     headers: {
       Authorization: 'Bearer:' + idToken
     }
   })
   ```

3. **レスポンスに応じた処理**
   - `isRegistered: true` → そのまま表示
   - `isRegistered: false` → `/register` にリダイレクト
   - エラー → エラー画面表示

---

## 📱 使用例

### 初回ユーザーの流れ

```
1. LINEからアプリを開く
   ↓
2. LIFF認証（自動）
   ↓
3. 「/」にアクセス
   ↓
4. UserAuthComponentが認証確認
   ↓
5. 未登録と判定 → 「/register」にリダイレクト
   ↓
6. 登録画面でプロフィール確認
   ↓
7. 「アカウント登録」ボタンをクリック
   ↓
8. API処理（Household & マスタデータ作成）
   ↓
9. 登録完了！「/home」にリダイレクト
   ↓
10. 家計簿の記録開始！
```

### 既存ユーザーの流れ

```
1. LINEからアプリを開く
   ↓
2. LIFF認証（自動）
   ↓
3. 「/」にアクセス
   ↓
4. UserAuthComponentが認証確認
   ↓
5. 登録済みと判定 → そのまま表示
   ↓
6. または手動で「/home」に遷移
   ↓
7. すぐに使える！
```

---

## 🛡️ セキュリティ

### 1. IDトークンの検証
- LINEが発行したIDトークンを検証
- `decodeIdToken` ユーティリティを使用
- 不正なトークンは拒否

### 2. ユーザー情報の保護
- FirestoreのSecurity Rulesで保護
- 自分のデータのみアクセス可能

### 3. Household分離
- 各ユーザーは独立したHouseholdを持つ
- 共有機能使用時のみ他のHouseholdにアクセス可能

---

## 🔧 開発者向け情報

### 認証・登録関連ファイル

| ファイル | 説明 |
|---------|------|
| `/src/app/api/auth/route.ts` | 認証確認API |
| `/src/app/api/auth/types.d.ts` | 認証API型定義 |
| `/src/app/api/register/route.ts` | ユーザー登録API |
| `/src/app/api/register/types.d.ts` | 登録API型定義 |
| `/src/app/register/page.tsx` | 登録画面 |
| `/src/components/context/user.tsx` | 認証コンテキスト |
| `/src/utils/line/decodeIdToken.ts` | IDトークンデコード |

### カスタマイズポイント

#### デフォルトマスタデータの変更
```typescript
// src/utils/defaults/categories.ts
export const DEFAULT_EXPENSE_CATEGORIES = [
  // ここにカテゴリを追加
];
```

#### Household名のカスタマイズ
```typescript
// src/app/api/register/route.ts
const householdData: Omit<Household, 'householdId'> = {
  name: `${decodeResult.name}の家計簿`, // ←ここを変更
  // ...
};
```

---

## ✅ テスト方法

### 1. 新規ユーザー登録のテスト

1. Firestoreから既存のユーザーデータを削除
2. LIFFアプリを開く
3. `/register` にリダイレクトされることを確認
4. 登録ボタンをクリック
5. 以下が作成されることを確認：
   - users/{userId}
   - households/{householdId}
   - categories（15件）
   - wallets（5件）
   - expenseTypes（7件）

### 2. 既存ユーザーのテスト

1. 一度登録済みの状態で
2. LIFFアプリを開く
3. すぐにホーム画面が表示されることを確認

### 3. エラーハンドリングのテスト

1. 無効なIDトークンでAPIを呼ぶ
2. 適切なエラーメッセージが返ることを確認

---

このドキュメントに従って、認証・登録機能を実装・テストしてください！

